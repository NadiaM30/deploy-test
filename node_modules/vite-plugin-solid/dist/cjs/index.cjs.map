{"version":3,"file":"index.cjs","sources":["../../src/index.ts"],"sourcesContent":["import { transformAsync, TransformOptions } from '@babel/core';\nimport ts from '@babel/preset-typescript';\nimport solid from 'babel-preset-solid';\nimport { readFileSync } from 'fs';\nimport { mergeAndConcat } from 'merge-anything';\nimport { createRequire } from 'module';\nimport solidRefresh from 'solid-refresh/babel.js';\nimport type { Alias, AliasOptions, Plugin, UserConfig } from 'vite';\n\nconst require = createRequire(import.meta.url);\n\nconst runtimePublicPath = '/@solid-refresh';\nconst runtimeFilePath = require.resolve('solid-refresh/dist/solid-refresh.mjs');\nconst runtimeCode = readFileSync(runtimeFilePath, 'utf-8');\n\n/** Configuration options for vite-plugin-solid. */\nexport interface Options {\n  /**\n   * This will inject solid-js/dev in place of solid-js in dev mode. Has no\n   * effect in prod. If set to `false`, it won't inject it in dev. This is\n   * useful for extra logs and debugging.\n   *\n   * @default true\n   */\n  dev: boolean;\n  /**\n   * This will force SSR code in the produced files. This is experiemental\n   * and mostly not working yet.\n   *\n   * @default false\n   */\n  ssr: boolean;\n  /**\n   * This will inject HMR runtime in dev mode. Has no effect in prod. If\n   * set to `false`, it won't inject the runtime in dev.\n   *\n   * @default true\n   */\n  hot: boolean;\n  /**\n   * Pass any additional babel transform options. They will be merged with\n   * the transformations required by Solid.\n   *\n   * @default {}\n   */\n  babel:\n    | TransformOptions\n    | ((source: string, id: string, ssr: boolean) => TransformOptions)\n    | ((source: string, id: string, ssr: boolean) => Promise<TransformOptions>);\n  typescript: {\n    /**\n     * Forcibly enables jsx parsing. Otherwise angle brackets will be treated as\n     * typescript's legacy type assertion var foo = <string>bar;. Also, isTSX:\n     * true requires allExtensions: true.\n     *\n     * @default false\n     */\n    isTSX?: boolean;\n\n    /**\n     * Replace the function used when compiling JSX expressions. This is so that\n     * we know that the import is not a type import, and should not be removed.\n     *\n     * @default React\n     */\n    jsxPragma?: string;\n\n    /**\n     * Replace the function used when compiling JSX fragment expressions. This\n     * is so that we know that the import is not a type import, and should not\n     * be removed.\n     *\n     * @default React.Fragment\n     */\n    jsxPragmaFrag?: string;\n\n    /**\n     * Indicates that every file should be parsed as TS or TSX (depending on the\n     * isTSX option).\n     *\n     * @default false\n     */\n    allExtensions?: boolean;\n\n    /**\n     * Enables compilation of TypeScript namespaces.\n     *\n     * @default uses the default set by @babel/plugin-transform-typescript.\n     */\n    allowNamespaces?: boolean;\n\n    /**\n     * When enabled, type-only class fields are only removed if they are\n     * prefixed with the declare modifier:\n     *\n     * > NOTE: This will be enabled by default in Babel 8\n     *\n     * @default false\n     *\n     * @example\n     * ```ts\n     * class A {\n     *   declare foo: string; // Removed\n     *   bar: string; // Initialized to undefined\n     *    prop?: string; // Initialized to undefined\n     *    prop1!: string // Initialized to undefined\n     * }\n     * ```\n     */\n    allowDeclareFields?: boolean;\n\n    /**\n     * When set to true, the transform will only remove type-only imports\n     * (introduced in TypeScript 3.8). This should only be used if you are using\n     * TypeScript >= 3.8.\n     *\n     * @default false\n     */\n    onlyRemoveTypeImports?: boolean;\n\n    /**\n     * When set to true, Babel will inline enum values rather than using the\n     * usual enum output:\n     *\n     * This option differs from TypeScript's --isolatedModules behavior, which\n     * ignores the const modifier and compiles them as normal enums, and aligns\n     * Babel's behavior with TypeScript's default behavior.\n     *\n     * ```ts\n     *  // Input\n     *  const enum Animals {\n     *    Fish\n     *  }\n     *  console.log(Animals.Fish);\n     *\n     *  // Default output\n     *  var Animals;\n     *\n     *  (function (Animals) {\n     *    Animals[Animals[\"Fish\"] = 0] = \"Fish\";\n     *  })(Animals || (Animals = {}));\n     *\n     *  console.log(Animals.Fish);\n     *\n     *  // `optimizeConstEnums` output\n     *  console.log(0);\n     * ```\n     *\n     * However, when exporting a const enum Babel will compile it to a plain\n     * object literal so that it doesn't need to rely on cross-file analysis\n     * when compiling it:\n     *\n     * ```ts\n     * // Input\n     * export const enum Animals {\n     *   Fish,\n     * }\n     *\n     * // `optimizeConstEnums` output\n     * export var Animals = {\n     *     Fish: 0,\n     * };\n     * ```\n     *\n     * @default false\n     */\n    optimizeConstEnums?: boolean;\n  };\n  /**\n   * Pass any additional [babel-plugin-jsx-dom-expressions](https://github.com/ryansolid/dom-expressions/tree/main/packages/babel-plugin-jsx-dom-expressions#plugin-options).\n   * They will be merged with the defaults sets by [babel-preset-solid](https://github.com/solidjs/solid/blob/main/packages/babel-preset-solid/index.js#L8-L25).\n   *\n   * @default {}\n   */\n  solid: {\n    /**\n     * The name of the runtime module to import the methods from.\n     *\n     * @default \"solid-js/web\"\n     */\n    moduleName?: string;\n\n    /**\n     * The output mode of the compiler.\n     * Can be:\n     * - \"dom\" is standard output\n     * - \"ssr\" is for server side rendering of strings.\n     *\n     * @default \"dom\"\n     */\n    generate?: 'ssr' | 'dom';\n\n    /**\n     * Indicate whether the output should contain hydratable markers.\n     *\n     * @default false\n     */\n    hydratable?: boolean;\n\n    /**\n     * Boolean to indicate whether to enable automatic event delegation on camelCase.\n     *\n     * @default true\n     */\n    delegateEvents?: boolean;\n\n    /**\n     * Boolean indicates whether smart conditional detection should be used.\n     * This optimizes simple boolean expressions and ternaries in JSX.\n     *\n     * @default true\n     */\n    wrapConditionals?: boolean;\n\n    /**\n     * Boolean indicates whether to set current render context on Custom Elements and slots.\n     * Useful for seemless Context API with Web Components.\n     *\n     * @default true\n     */\n    contextToCustomElements?: boolean;\n\n    /**\n     * Array of Component exports from module, that aren't included by default with the library.\n     * This plugin will automatically import them if it comes across them in the JSX.\n     *\n     * @default [\"For\",\"Show\",\"Switch\",\"Match\",\"Suspense\",\"SuspenseList\",\"Portal\",\"Index\",\"Dynamic\",\"ErrorBoundary\"]\n     */\n    builtIns?: string[];\n  };\n}\n\nexport default function solidPlugin(options: Partial<Options> = {}): Plugin {\n  let needHmr = false;\n  let replaceDev = false;\n  let projectRoot = process.cwd();\n\n  return {\n    name: 'solid',\n    enforce: 'pre',\n\n    config(userConfig, { command }): UserConfig {\n      // We inject the dev mode only if the user explicitely wants it or if we are in dev (serve) mode\n      replaceDev = options.dev === true || (options.dev !== false && command === 'serve');\n      projectRoot = userConfig.root;\n\n      // TODO: remove when fully removed from vite\n      const legacyAlias = normalizeAliases(userConfig.alias);\n\n      if (!userConfig.resolve) userConfig.resolve = {};\n      userConfig.resolve.alias = [...legacyAlias, ...normalizeAliases(userConfig.resolve?.alias)];\n\n      // fix for bundling dev in production\n      const nestedDeps = replaceDev ? [\n        'solid-js',\n        'solid-js/web',\n        'solid-js/store',\n        'solid-js/html',\n        'solid-js/h',\n      ] : [];\n\n      return {\n        /**\n         * We only need esbuild on .ts or .js files.\n         * .tsx & .jsx files are handled by us\n         */\n        esbuild: { include: /\\.ts$/ },\n        resolve: {\n          conditions: ['solid', ...(replaceDev ? ['development'] : [])],\n          dedupe: nestedDeps,\n          alias: [{ find: /^solid-refresh$/, replacement: runtimePublicPath }],\n        },\n        optimizeDeps: {\n          include: nestedDeps,\n        },\n      } as UserConfig;\n    },\n\n    configResolved(config) {\n      needHmr = config.command === 'serve' && !config.isProduction && options.hot !== false;\n    },\n\n    resolveId(id) {\n      if (id === runtimePublicPath) return id;\n    },\n\n    load(id) {\n      if (id === runtimePublicPath) return runtimeCode;\n    },\n\n    async transform(source, id, transformOptions) {\n      // @ts-expect-error anticipate vite changing second parameter as options object\n      // see https://github.com/vitejs/vite/discussions/5109\n      const ssr: boolean = transformOptions === true || transformOptions?.ssr;\n\n      if (!/\\.[jt]sx/.test(id)) return null;\n      const inNodeModules = /node_modules/.test(id);\n\n      let solidOptions: { generate: 'ssr' | 'dom'; hydratable: boolean };\n\n      if (options.ssr) {\n        if (ssr) {\n          solidOptions = { generate: 'ssr', hydratable: true };\n        } else {\n          solidOptions = { generate: 'dom', hydratable: true };\n        }\n      } else {\n        solidOptions = { generate: 'dom', hydratable: false };\n      }\n\n      const opts: TransformOptions = {\n        babelrc: false,\n        configFile: false,\n        root: projectRoot,\n        filename: id,\n        sourceFileName: id,\n        presets: [[solid, { ...solidOptions, ...(options.solid || {}) }]],\n        plugins: needHmr && !inNodeModules ? [[solidRefresh, { bundler: 'vite' }]] : [],\n        sourceMaps: true,\n        // Vite handles sourcemap flattening\n        inputSourceMap: false as any,\n      };\n\n      if (id.includes('tsx')) {\n        opts.presets.push([ts, options.typescript || {}]);\n      }\n\n      // Default value for babel user options\n      let babelUserOptions: TransformOptions = {};\n\n      if (options.babel) {\n        if (typeof options.babel === 'function') {\n          const babelOptions = options.babel(source, id, ssr);\n          babelUserOptions = babelOptions instanceof Promise ? await babelOptions : babelOptions;\n        } else {\n          babelUserOptions = options.babel;\n        }\n      }\n\n      const babelOptions = mergeAndConcat(babelUserOptions, opts) as TransformOptions;\n\n      const { code, map } = await transformAsync(source, babelOptions);\n\n      return { code, map };\n    },\n  };\n}\n\n/**\n * This basically normalize all aliases of the config into\n * the array format of the alias.\n *\n * eg: alias: { '@': 'src/' } => [{ find: '@', replacement: 'src/' }]\n */\nfunction normalizeAliases(alias: AliasOptions = []): Alias[] {\n  return Array.isArray(alias)\n    ? alias\n    : Object.entries(alias).map(([find, replacement]) => ({ find, replacement }));\n}\n"],"names":["require","createRequire","import","runtimePublicPath","runtimeFilePath","resolve","runtimeCode","readFileSync","solidPlugin","options","needHmr","replaceDev","projectRoot","process","cwd","name","enforce","config","userConfig","command","dev","root","legacyAlias","normalizeAliases","alias","nestedDeps","esbuild","include","conditions","dedupe","find","replacement","optimizeDeps","configResolved","isProduction","hot","resolveId","id","load","transform","source","transformOptions","ssr","test","inNodeModules","solidOptions","generate","hydratable","opts","babelrc","configFile","filename","sourceFileName","presets","solid","plugins","solidRefresh","bundler","sourceMaps","inputSourceMap","includes","push","ts","typescript","babelUserOptions","babel","babelOptions","Promise","mergeAndConcat","code","map","transformAsync","Array","isArray","Object","entries"],"mappings":";;;;;;;;;;;;;;;;AASA,MAAMA,SAAO,GAAGC,sBAAa,CAACC,oMAAD,CAA7B;;AAEA,MAAMC,iBAAiB,GAAG,iBAA1B;;AACA,MAAMC,eAAe,GAAGJ,SAAO,CAACK,OAAR,CAAgB,sCAAhB,CAAxB;;AACA,MAAMC,WAAW,GAAGC,eAAY,CAACH,eAAD,EAAkB,OAAlB,CAAhC;AAEA;;AAyNe,SAASI,WAAT,CAAqBC,OAAyB,GAAG,EAAjD,EAA6D;AAC1E,MAAIC,OAAO,GAAG,KAAd;AACA,MAAIC,UAAU,GAAG,KAAjB;AACA,MAAIC,WAAW,GAAGC,OAAO,CAACC,GAAR,EAAlB;AAEA,SAAO;AACLC,IAAAA,IAAI,EAAE,OADD;AAELC,IAAAA,OAAO,EAAE,KAFJ;;AAILC,IAAAA,MAAM,CAACC,UAAD,EAAa;AAAEC,MAAAA;AAAF,KAAb,EAAsC;AAAA;;AAC1C;AACAR,MAAAA,UAAU,GAAGF,OAAO,CAACW,GAAR,KAAgB,IAAhB,IAAyBX,OAAO,CAACW,GAAR,KAAgB,KAAhB,IAAyBD,OAAO,KAAK,OAA3E;AACAP,MAAAA,WAAW,GAAGM,UAAU,CAACG,IAAzB,CAH0C;;AAM1C,YAAMC,WAAW,GAAGC,gBAAgB,CAACL,UAAU,CAACM,KAAZ,CAApC;AAEA,UAAI,CAACN,UAAU,CAACb,OAAhB,EAAyBa,UAAU,CAACb,OAAX,GAAqB,EAArB;AACzBa,MAAAA,UAAU,CAACb,OAAX,CAAmBmB,KAAnB,GAA2B,CAAC,GAAGF,WAAJ,EAAiB,GAAGC,gBAAgB,wBAACL,UAAU,CAACb,OAAZ,wDAAC,oBAAoBmB,KAArB,CAApC,CAA3B,CAT0C;;AAY1C,YAAMC,UAAU,GAAGd,UAAU,GAAG,CAC9B,UAD8B,EAE9B,cAF8B,EAG9B,gBAH8B,EAI9B,eAJ8B,EAK9B,YAL8B,CAAH,GAMzB,EANJ;AAQA,aAAO;AACL;AACR;AACA;AACA;AACQe,QAAAA,OAAO,EAAE;AAAEC,UAAAA,OAAO,EAAE;AAAX,SALJ;AAMLtB,QAAAA,OAAO,EAAE;AACPuB,UAAAA,UAAU,EAAE,CAAC,OAAD,EAAU,IAAIjB,UAAU,GAAG,CAAC,aAAD,CAAH,GAAqB,EAAnC,CAAV,CADL;AAEPkB,UAAAA,MAAM,EAAEJ,UAFD;AAGPD,UAAAA,KAAK,EAAE,CAAC;AAAEM,YAAAA,IAAI,EAAE,iBAAR;AAA2BC,YAAAA,WAAW,EAAE5B;AAAxC,WAAD;AAHA,SANJ;AAWL6B,QAAAA,YAAY,EAAE;AACZL,UAAAA,OAAO,EAAEF;AADG;AAXT,OAAP;AAeD,KAvCI;;AAyCLQ,IAAAA,cAAc,CAAChB,MAAD,EAAS;AACrBP,MAAAA,OAAO,GAAGO,MAAM,CAACE,OAAP,KAAmB,OAAnB,IAA8B,CAACF,MAAM,CAACiB,YAAtC,IAAsDzB,OAAO,CAAC0B,GAAR,KAAgB,KAAhF;AACD,KA3CI;;AA6CLC,IAAAA,SAAS,CAACC,EAAD,EAAK;AACZ,UAAIA,EAAE,KAAKlC,iBAAX,EAA8B,OAAOkC,EAAP;AAC/B,KA/CI;;AAiDLC,IAAAA,IAAI,CAACD,EAAD,EAAK;AACP,UAAIA,EAAE,KAAKlC,iBAAX,EAA8B,OAAOG,WAAP;AAC/B,KAnDI;;AAqDL,UAAMiC,SAAN,CAAgBC,MAAhB,EAAwBH,EAAxB,EAA4BI,gBAA5B,EAA8C;AAC5C;AACA;AACA,YAAMC,GAAY,GAAGD,gBAAgB,KAAK,IAArB,KAA6BA,gBAA7B,aAA6BA,gBAA7B,uBAA6BA,gBAAgB,CAAEC,GAA/C,CAArB;AAEA,UAAI,CAAC,WAAWC,IAAX,CAAgBN,EAAhB,CAAL,EAA0B,OAAO,IAAP;AAC1B,YAAMO,aAAa,GAAG,eAAeD,IAAf,CAAoBN,EAApB,CAAtB;AAEA,UAAIQ,YAAJ;;AAEA,UAAIpC,OAAO,CAACiC,GAAZ,EAAiB;AACf,YAAIA,GAAJ,EAAS;AACPG,UAAAA,YAAY,GAAG;AAAEC,YAAAA,QAAQ,EAAE,KAAZ;AAAmBC,YAAAA,UAAU,EAAE;AAA/B,WAAf;AACD,SAFD,MAEO;AACLF,UAAAA,YAAY,GAAG;AAAEC,YAAAA,QAAQ,EAAE,KAAZ;AAAmBC,YAAAA,UAAU,EAAE;AAA/B,WAAf;AACD;AACF,OAND,MAMO;AACLF,QAAAA,YAAY,GAAG;AAAEC,UAAAA,QAAQ,EAAE,KAAZ;AAAmBC,UAAAA,UAAU,EAAE;AAA/B,SAAf;AACD;;AAED,YAAMC,IAAsB,GAAG;AAC7BC,QAAAA,OAAO,EAAE,KADoB;AAE7BC,QAAAA,UAAU,EAAE,KAFiB;AAG7B7B,QAAAA,IAAI,EAAET,WAHuB;AAI7BuC,QAAAA,QAAQ,EAAEd,EAJmB;AAK7Be,QAAAA,cAAc,EAAEf,EALa;AAM7BgB,QAAAA,OAAO,EAAE,CAAC,CAACC,yBAAD,EAAQ,EAAE,GAAGT,YAAL;AAAmB,cAAIpC,OAAO,CAAC6C,KAAR,IAAiB,EAArB;AAAnB,SAAR,CAAD,CANoB;AAO7BC,QAAAA,OAAO,EAAE7C,OAAO,IAAI,CAACkC,aAAZ,GAA4B,CAAC,CAACY,gCAAD,EAAe;AAAEC,UAAAA,OAAO,EAAE;AAAX,SAAf,CAAD,CAA5B,GAAoE,EAPhD;AAQ7BC,QAAAA,UAAU,EAAE,IARiB;AAS7B;AACAC,QAAAA,cAAc,EAAE;AAVa,OAA/B;;AAaA,UAAItB,EAAE,CAACuB,QAAH,CAAY,KAAZ,CAAJ,EAAwB;AACtBZ,QAAAA,IAAI,CAACK,OAAL,CAAaQ,IAAb,CAAkB,CAACC,sBAAD,EAAKrD,OAAO,CAACsD,UAAR,IAAsB,EAA3B,CAAlB;AACD,OAnC2C;;;AAsC5C,UAAIC,gBAAkC,GAAG,EAAzC;;AAEA,UAAIvD,OAAO,CAACwD,KAAZ,EAAmB;AACjB,YAAI,OAAOxD,OAAO,CAACwD,KAAf,KAAyB,UAA7B,EAAyC;AACvC,gBAAMC,YAAY,GAAGzD,OAAO,CAACwD,KAAR,CAAczB,MAAd,EAAsBH,EAAtB,EAA0BK,GAA1B,CAArB;AACAsB,UAAAA,gBAAgB,GAAGE,YAAY,YAAYC,OAAxB,GAAkC,MAAMD,YAAxC,GAAuDA,YAA1E;AACD,SAHD,MAGO;AACLF,UAAAA,gBAAgB,GAAGvD,OAAO,CAACwD,KAA3B;AACD;AACF;;AAED,YAAMC,YAAY,GAAGE,4BAAc,CAACJ,gBAAD,EAAmBhB,IAAnB,CAAnC;AAEA,YAAM;AAAEqB,QAAAA,IAAF;AAAQC,QAAAA;AAAR,UAAgB,MAAMC,mBAAc,CAAC/B,MAAD,EAAS0B,YAAT,CAA1C;AAEA,aAAO;AAAEG,QAAAA,IAAF;AAAQC,QAAAA;AAAR,OAAP;AACD;;AA3GI,GAAP;AA6GD;AAED;AACA;AACA;AACA;AACA;AACA;;AACA,SAAS/C,gBAAT,CAA0BC,KAAmB,GAAG,EAAhD,EAA6D;AAC3D,SAAOgD,KAAK,CAACC,OAAN,CAAcjD,KAAd,IACHA,KADG,GAEHkD,MAAM,CAACC,OAAP,CAAenD,KAAf,EAAsB8C,GAAtB,CAA0B,CAAC,CAACxC,IAAD,EAAOC,WAAP,CAAD,MAA0B;AAAED,IAAAA,IAAF;AAAQC,IAAAA;AAAR,GAA1B,CAA1B,CAFJ;AAGD;;;;"}